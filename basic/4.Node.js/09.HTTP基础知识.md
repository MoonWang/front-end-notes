# 一、基础知识

## 1.1 网络请求中的 HTTP 和 TCP 协议职责

<img src="./images/09/tcphttp.png">

- 资源请求过程中：
    - 客户端（已从 DNS 服务器获取实际 IP）
        - HTTP 协议：生成针对目标 Web 服务器的 HTTP 请求报文
        - TCP 协议：为了方便通信，将 HTTP 请求报文分割成报文段，并设置序号，实现可靠发送
    - 中转传输
        - IP 协议：搜索对方的地址，一边中转一遍传送
    - 服务器
        - TCP 协议：将接受到的报文段重组，按照原来的顺序
        - HTTP 协议：对 Web 服务器请求的内容进行处理
- 资源回传过程中：
    - 同样利用 TCP/IP 通信协议向用户进行回传

## 1.2 不同版本 HTTP 协议 

> HTTP 性能优化的关键并不在于高带宽，而是低延迟；关注于减少延迟时间，从而提高页面加载速度

- HTTP 1.0 
    - 一次请求-响应，建立一个连接，用完关闭；每一个请求都要建立一个连接
    - http1 一般浏览器在同域名下的并发限制在 4-6 个，可以考虑影子域名加载静态资源
    - 这涉及建立连接（三次握手无法复用）和数据包传输，是非常耗时的过程
        - TCP 连接会随着时间进行自我「调谐」，起初会限制连接的最大速度，如果数据成功传输，会随着时间的推移提高传输的速度
        - 这种调谐则被称为 TCP 慢启动，由于这种原因，让原本就具有突发性和短时性的 HTTP 连接变的十分低效
- HTTP 1.1 
    - 长连接
        - 减少建立连接的耗时，只要建立连接就能一次性发送请求的资源
        - 默认开启 Connection： keep-alive
    - Pipeling 管线化（复用 tcp 链接）
        - 理论上允许在单一的连接中发送多个请求，但请求和响应需要同步处理（排队串行化单线程处理）
        - HTTP 复用则是一个客户端的多个 HTTP 请求通过一个 TCP 连接进行处理，是 HTTP 1.1 协议所支持的新功能
        - TCP 连接复用是将多个客户端的 HTTP 请求复用到一个服务器端 TCP 连接上，是负载均衡设备的独特功能
- HTTP 2 
    - 基于 SPDY 协议的，打开一个 TCP 连接并重复使用，这使得许多请求得以并行发送，而无需等待响应。
        - google 推出，优化1.x请求延迟和安全性
        - 多路复用、降低延迟，减少建立连接需要的耗时
        - 可以设置请求优先级？
        - header 压缩，减小体积
        - 基于 HTTPS 加密协议传输
        - 服务端推送，客户端请求 style.css 时，服务端把 style.js 也推送过来
    - 支持压缩 HTTP headers ，维护一个字典，差量更新HTTP头部
    - 支持服务器推送，提高响应速度（读内存）
    - 多路复用，通过让所有数据流共用同一个连接，可以更有效地使用 TCP 连接，让高带宽也能真正的服务于 HTTP 的性能提升
        - 补充：图片的多域名并行下载
    - 新的二进制格式（Binary Format）

## 1.3 URI和URL

### URI

> URI(Uniform Resource Identifier) 统一资源标识符，在某个规则下能把这个资源独一无二标示出来，比如人的身份证号

- Uniform 不用根据上下文来识别资源指定的访问方式
- Resource 可以标识的任何东西
- Identifier 表示可标识的对象

### URL

> 统一资源定位符，表示资源的地点，URL时使用浏览器访问WEB页面时需要输入的网页地址

- 作用
    - Uniform 不用根据上下文来识别资源指定的访问方式
    - Resource 可以标识的任何东西
    - Location 定位
- 格式
    - eg: http://user:pass@www.baidu.com:80/test/index.html?uid=1#ch1
    - 协议类型 http://
    - 登录信息 user:pass，不安全没用过
    - 服务器地址 www.baidu.com
    - 服务器端口号 80
    - 带层次的文件路径 /test/index.html
    - 查询字符串 uid=1
    - 片段标识符 ch1

# 二、HTTP 协议基础

- 请求的一方叫客户端，响应的一方叫服务器端
- 通过请求和响应达成通信
- HTTP是一种不保存状态的协议

## 2.1 请求报文

<img src="./images/09/request.png">

> 请求报文 = 请求报文头( 请求行 + 请求头 ) + 空行 + 请求报文体

- 请求行
    - 方法
        - GET 获取资源
        - POST 向服务器端发送数据，传输实体主体
        - PUT 传输文件
        - HEAD 获取报文首部
        - DELETE 删除文件
        - OPTIONS 询问支持的方法，如 post 请求前会先发 options 请求
        - TRACE 追踪路径，很少用，可以设置 Max-Forwards 跳步最大值来决定中间服务器的最大个数
    - URL 
        - /form/entry
    - 协议版本
        - HTTP/1.1
- 请求头
    - 请求首部(Request Header)，详见附录
    - 通用首部(General Header)
    - 实体首部(Entity Header Fields)
        - Content-xxx 描述请求体的信息
- 请求体

## 2.2 响应报文

<img src="./images/09/response.png">

> 响应报文 = 响应报文头( 响应行 + 响应头 ) + 空行 + 响应报文体

- 响应行
    - 协议版本
    - 状态码
    - 状态码的原因短语，如 200 OK
- 响应头
    - 响应首部(Response Header)
    - 通用首部(General Header)
    - 实体首部(Entity Header Fields)
- 响应体

## 2.3 编码

> HTTP可以在传输的过程中通过编码提升传输效率，但是会消耗更多的CPU时间

### 编码压缩 Accept-Encoding

发送文件时可以先用 ZIP 压缩功能后再发送文件，体积小传输快，但是压缩和解压需要时间

- gzip
- compress
- deflate
- identify

### 编码分割

请求的实体在尚未传输完成前浏览器不能显示。所以在传输大容量数据时，通过把数据分割成多块（chunk），能让浏览器逐步显示页面。

常见例子就是前些年网速不给力的时候，大图加载时，一部分一部分的进行显示。

### 多部分对象集合

特点：
- 一份报文主体中可以包含多类型实体（文本、图片、音频、视频等）
- 使用 boundary 字符串来划分多部分对象指明的各类实体
    - 各个实体起始行之前插入「--boundary」，多部分对象集合最后插入「--boundary」
    - 两个「--boundary」之间是一组数据，数据信息和数据内容用空白行隔开

例子：
- multipart/form-data 
    - 表单上传
- multipart/byteranges 206(Particial Content) 
    - 断点续传
    - 状态码(Partical Content)响应报文中包含多个范围时用

<img src="./images/09/form-data.png">

### 范围请求（部分获取）

> 断点续传，为了实现中断恢复下载的需求，需要能下载指定下载的实体范围

- 请求头中 Range 指定资源的 byte 范围
    - 5001~10000 字节
        - Range: bytes=5001-10000
    - 从 5001 字节之后全部
        - Range: bytes=5001-
    - 从开始到 5001 字节
        - Range: bytes=-5001
    - 从开始到 3000 字节和 5000~7000 字节的多重范围
        - Range: bytes=-3000, 5000-7000
- 响应会返回状态码 206 响应报文
- 对于多重范围的范围请求，响应首部字段 Content-Type:multipart/byteranges

## 2.4 内容协商

- 首部字段
    - Accept
    - Accept-Charset 字符集
    - Accept-Encoding 压缩、加密
        - Content-Encoding 实体的编码方式，可用于实现个性化压缩，要选择客户端和服务端都支持的压缩格式
    - Accept-Language 优先语言，可用于实现多语言
        - Content-Language 实体的自然语言
- 协商类型
    - 服务器驱动，根据客户端想要的格式来返回内容
    - 客户端驱动，由用户主动选择来影响结果
    - 透明协商

## 2.5 状态码

> 状态码负责表示客户端请求的返回结果、标记服务器端是否正常、通知出现的错误。记住下面标粗的15个差不多了。

- 1xx Informational(信息性状态码/临时响应)
    - 表示临时响应并需要请求者继续执行操作的状态代码
    - 100（继续） 
        - 请求者应当继续提出请求，服务器返回此代码表示已收到请求的第一部分，正在等待其余部分 
    - **101（切换协议，websocket连接）**
        - 请求者已要求服务器切换协议，服务器已确认并准备切换
- 2xx Success(成功状态码)
    - 表示成功处理了请求的状态代码
    - **200（成功，最想看到的）**  
        - 服务器已成功处理了客户端发过来的数据被正常处理 
    - 201（已创建）  
        - 请求成功并且服务器创建了新的资源
    - 202（已接受）  
        - 服务器已接受请求，但尚未处理
    - 203（非授权信息）  
        - 服务器已成功处理了请求，但返回的信息可能来自另一来源 
    - **204（无内容，gif上报信息）**
        - 服务器成功处理了请求，但没有返回任何内容 
    - 205（重置内容） 
        - 服务器成功处理了请求，但没有返回任何内容
    - **206（部分内容，断点续传）** 
        - 范围请求，返回部分数据，响应报文中由Content-Range指定实体内容
- 3xx Redirection(重定向)
    - 表示要完成请求，需要进一步操作。通常，这些状态代码用来重定向
    - 300（多种选择）  
        - 针对请求，服务器可执行多种操作。服务器可根据请求者(user agent)选择一项操作，或提供操作列表供请求者选择。
    - **301（永久移动，重定向）**
        - 请求的网页已永久移动到新位置。服务器返回此响应（对 GET/HEAD 请求的响应）时，会自动将请求者转到新位置
        - 可以理解为错误的一种，不要再访问了
        - 爬虫会收录新的地址
            - TODO 是否有本地缓存？即第一次访问原地址出现301，后续自动访问新地址，但是当缓存清除时，仍会访问原地址？
    - **302（临时移动，常见的重定向）**
        - 服务器目前从不同位置的网页响应请求，但请求者应继续使用原有位置来进行以后的请求
        - 爬虫会收录旧地址
        - 规定方法名不变，但是都会改变成 GET 
    - **303（查看其他位置）** 
        - 和 302 类似，但是必须用 GET 方法
        - 请求者应当对不同的位置使用单独的 GET 请求来检索响应时，服务器返回此代码
    - **304（未修改，协商缓存）** 
        - 自从上次请求后，请求的网页未修改过。服务器返回此响应时，不会返回网页内容。
        - 配合(If-Match、If-Modified-Since、If-None_Match、If-Range、If-Unmodified-Since)
    - 305（使用代理） 
        - 请求者只能使用代理访问请求的网页。如果服务器返回此响应，还表示请求者应使用代理
    - **307（临时重定向）**
        - 和 302 相近，但不改变请求方法
        - 服务器目前从不同位置的网页响应请求，但请求者应继续使用原有位置来进行以后的请求
- 4xx Client Error(客户端错误状态码)	
    - 这些状态代码表示请求可能出错，妨碍了服务器的处理
    - **400（请求报文语法错误）** 
        - 服务器不理解请求的语法
    - **401（未授权，需要认证）** 
        - 请求要求身份验证对于需要登录的网页，服务器可能返回此响应
    - **403（禁止访问，权限不足）**
        - 服务器拒绝请求
    - **404（未找到资源）** 
        - 服务器找不到请求的网页
    - 405（方法禁用） 
        - 禁用请求中指定的方法
    - 406（不接受） 
        - 无法使用请求的内容特性响应请求的网页
- 5xx Server Error(服务器错误状态码)
    - 这些状态代码表示服务器在尝试处理请求时发生内部错误。这些错误可能是服务器本身的错误，而不是请求出错
    - **500（服务器内部错误，宕掉了）**
        - 服务器遇到错误，无法完成请求
    - 501（尚未实施）
        - 服务器不具备完成请求的功能例如，服务器无法识别请求方法时可能会返回此代码
    - 502（错误网关） 
        - 服务器作为网关或代理，从上游服务器收到无效响应
    - **503（服务不可用，超载、停机）** 
        - 服务器目前无法使用（由于超载或停机维护）通常，这只是暂时状态
    - 504（网关超时）  
        - 服务器作为网关或代理，但是没有及时从上游服务器收到请求
    - 505（HTTP 版本不受支持） 
        - 服务器不支持请求中所用的 HTTP 协议版本

# 三、Web 服务器基础

## 虚拟主机(Virtual Host)

一台 HTTP 服务器上搭建多个 Web 站点，客户端发送请求时必须在 **Host 首部完整指定主机名或域名的 URL** 用于区分

## 通信转发程序

- 代理：客户端和服务器的中间人
    - 用途
        - 利用缓存技术减少网络流量
        - 对网站进行访问控制
        - 获取访问日志
    - 分类
        - 缓存代理 会预先把资源副本保存在服务器上
            - CDN
                - 第一次访问回源请求，从中央服务器拉取数据，并缓存
                - SRU算法，访问量排序，定时清理无访问的数据
        - 透明代理 不对报文进行任何加工
    - 内网访问外网时使用
        - nginx 反向代理应该算是网关
- 网关
    - 接收从客户端发送来的数据时，会转发给其他服务器处理，再由自己返回
    - 用途
        - 使通信线路上的服务器提供非HTTP协议服务
            - rpc 远程过程调用
            - mysql 数据库
        - 提高通信安全性
    - 外网访问内网时使用，外网不知道服务的具体提供者

# 附：首部

## 通用首部字段

首部字段名	| 说明
-- | --
Cache-Control	| 控制缓存行为
Connection	| 链接的管理
Date	| 报文日期
Pragma	| 报文指令
Trailer	| 报文尾部的首部
Trasfer-Encoding	| 指定报文主体的传输编码方式
Upgrade	| 升级为其他协议
Via	| 代理服务器信息
Warning	| 错误通知

## 请求首部字段

首部字段名	| 说明
-- | --
Accept	| 用户代理可处理的媒体类型
Accept-Charset	| 优先的字符集
Accept-Encoding	| 优先的编码
Accept-Langulage	| 优先的语言
Authorization	| Web认证信息
Expect	| 期待服务器的特定行为
From	| 用户的电子邮箱地址
Host	| 请求资源所在的服务器
If-Match	| 比较实体标记
If-Modified-Since	| 比较资源的更新时间
If-None-Match	| 比较实体标记
If-Range	| 资源未更新时发送实体Byte的范围请求
If-Unmodified-Since	| 比较资源的更新时间(和If-Modified-Since相反)
Max-Forwards	| 最大传输跳数
Proxy-Authorization	| 代理服务器需要客户端认证
Range	| 实体字节范围请求
Referer	| 请求中的URI的原始获取方
TE	| 传输编码的优先级
User-Agent	| HTTP客户端程序的信息

## 响应首部字段

首部字段名	| 说明
-- | --
Accept-Ranges	| 是否接受字节范围
Age	| 资源的创建时间
ETag	| 资源的匹配信息
Location	| 客户端重定向至指定的URI
Proxy-Authenticate	| 代理服务器对客户端的认证信息
Retry-After	| 再次发送请求的时机
Server	| 服务器的信息
Vary	| 代理服务器缓存的管理信息
www-Authenticate | 服务器对客户端的认证

## 实体首部字段

首部字段名	| 说明
-- | --
Allow	| 资源可支持的HTTP方法
Content-Encoding	| 实体的编码方式
Content-Language	| 实体的自然语言
Content-Length	| 实体的内容大小(字节为单位)
Content-Location	| 替代对应资源的URI
Content-MD5	| 实体的报文摘要
Content-Range	| 实体的位置范围
Content-Type	| 实体主体的媒体类型
Expires	| 实体过期时间
Last-Modified	| 资源的最后修改时间
